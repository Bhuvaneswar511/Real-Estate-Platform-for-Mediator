#!/usr/bin/env python3
"""
Test script to verify Cloudinary connection directly
"""

import cloudinary
import cloudinary.uploader
import os
import tempfile
from config import Config

def test_cloudinary_connection():
    """Test direct Cloudinary connection"""
    print("🔧 Testing Cloudinary connection...")
    
    # Configure Cloudinary with the same settings as the app
    cloudinary.config(
        cloud_name=Config.CLOUD_NAME,
        api_key=Config.CLOUDINARY_API_KEY,
        api_secret=Config.CLOUDINARY_API_SECRET
    )
    
    print(f"☁️ Cloud Name: {Config.CLOUD_NAME}")
    print(f"🔑 API Key: {Config.CLOUDINARY_API_KEY[:8]}...")
    print(f"🔐 API Secret: {Config.CLOUDINARY_API_SECRET[:8]}...")
    
    # Create a small test image
    test_image_path = "cloudinary_test.jpg"
    jpeg_header = bytes([
        0xFF, 0xD8, 0xFF, 0xE0, 0x00, 0x10, 0x4A, 0x46, 0x49, 0x46, 0x00, 0x01,
        0x01, 0x01, 0x00, 0x48, 0x00, 0x48, 0x00, 0x00, 0xFF, 0xDB, 0x00, 0x43,
        0x00, 0x08, 0x06, 0x06, 0x07, 0x06, 0x05, 0x08, 0x07, 0x07, 0x07, 0x09,
        0x09, 0x08, 0x0A, 0x0C, 0x14, 0x0D, 0x0C, 0x0B, 0x0B, 0x0C, 0x19, 0x12,
        0x13, 0x0F, 0x14, 0x1D, 0x1A, 0x1F, 0x1E, 0x1D, 0x1A, 0x1C, 0x1C, 0x20,
        0x24, 0x2E, 0x27, 0x20, 0x22, 0x2C, 0x23, 0x1C, 0x1C, 0x28, 0x37, 0x29,
        0x2C, 0x30, 0x31, 0x34, 0x34, 0x34, 0x1F, 0x27, 0x39, 0x3D, 0x38, 0x32,
        0x3C, 0x2E, 0x33, 0x34, 0x32, 0xFF, 0xC0, 0x00, 0x11, 0x08, 0x00, 0x01,
        0x00, 0x01, 0x01, 0x01, 0x11, 0x00, 0x02, 0x11, 0x01, 0x03, 0x11, 0x01,
        0xFF, 0xC4, 0x00, 0x14, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0xFF, 0xC4,
        0x00, 0x14, 0x10, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xDA, 0x00, 0x0C,
        0x03, 0x01, 0x00, 0x02, 0x11, 0x03, 0x11, 0x00, 0x3F, 0x00, 0x00, 0xFF, 0xD9
    ])
    
    try:
        with open(test_image_path, 'wb') as f:
            f.write(jpeg_header)
        
        print("📤 Attempting Cloudinary upload...")
        
        # Try to upload to Cloudinary
        with open(test_image_path, 'rb') as f:
            result = cloudinary.uploader.upload(f)
            
        print("✅ Cloudinary upload successful!")
        print(f"🔗 URL: {result.get('secure_url', result.get('url'))}")
        print(f"📊 Public ID: {result.get('public_id')}")
        print(f"📏 Size: {result.get('bytes')} bytes")
        
        return True
        
    except Exception as e:
        print(f"❌ Cloudinary upload failed: {e}")
        print(f"🔍 Error type: {type(e).__name__}")
        
        # Try to get more details
        if hasattr(e, 'response'):
            print(f"📋 Response: {e.response}")
        
        return False
        
    finally:
        # Clean up
        if os.path.exists(test_image_path):
            os.remove(test_image_path)

if __name__ == "__main__":
    test_cloudinary_connection()
